#!perl

=head1 NAME

  Timetracker

=cut

our ($html, 
  %FORM, 
  $db, 
  %conf, 
  $admin,
  %lang);

use Timetracker::db::Timetracker;
my $Timetracker = Timetracker->new($db, $admin, \%conf);

use Data::Dumper;
use strict;


#**********************************************************
=head2 timetracker() - Accounting and time allocation

=cut
#**********************************************************


sub timetracker {

  if ($FORM{add_form}) {

    my $date_for_picker = $DATE;

    if ($FORM{"NAMEADD"}) {
      $Timetracker->add(
        {
          NAME => $FORM{NAMEADD},
          NUM1 => $FORM{SUPPORT},
          NUM2 => $FORM{SPRINT},
          NUM3 => $FORM{OSBB},
          DATE => $FORM{DATE},
        }
      );

      $html->message("info", $lang{ADD_MASSAGE}, $lang{OPERATION});
      $date_for_picker = $FORM{DATE};
    }
    elsif ($FORM{delete}) {
      $Timetracker->del($FORM{delete});

      $html->message("info", $lang{DELETE_MASSAGE}, $lang{OPERATION});
    }

    $html->tpl_show(_include("timetracker_add_form", "Timetracker"), { ADMIN => $admin->{A_FIO}, DATEPICKER => $html->form_datepicker("DATE", $date_for_picker) });

    my $table = $html->table(
      {
        width   => "100%",
        caption => $lang{ALL_FILLING},
        title   => [ $lang{DATE}, $lang{SUPPORT_TIMETRACK}, $lang{SPRINT_TIMETRACK}, $lang{OSBB}, "" ],
        qs      => $pages_qs,
        ID      => "TABLE_ID",
        export  => 1
      }
    );

    my $Timetracker_list = $Timetracker->list({ COLS_NAME => 1, DESC => "desc", NAME => $admin->{A_FIO} });

    foreach my $item (@$Timetracker_list) {
      my $del_button = $html->button("", "index=$index&delete=$item->{id}", { class => "text-danger", ADD_ICON => "glyphicon glyphicon-trash" });
      $table->addrow($item->{date},, $item->{num1}, $item->{num2}, $item->{num3}, $del_button);
    }

    print $table->show();

  }
  else {

    reports({ DATE => $FORM{FROM_DATE_TO_DATE}, PERIOD_FORM => 1, NO_GROUP => 1, NO_TAGS => 1, DATE_RANGE => 1 });

    my %hash             = ();
    my $Timetracker_list = $Timetracker->listfortimetracker({ COLS_NAME => 1, DATE => $FORM{FROM_DATE_TO_DATE} });

    my $table = $html->table(
      {
        width   => "100%",
        caption => $lang{TIMETRACKER},
        title   => [ $lang{NAME}, $lang{SUPPORT_TIMETRACK}, $lang{SPRINT_TIMETRACK}, $lang{OSBB}, $lang{COEFFICIENT} ],
        qs      => $pages_qs,
        ID      => "TABLE_ID",
        MENU    => "$lang{ADD}:index=$index&add_form=1&$pages_qs:add",
        export  => 1,
      }
    );

    foreach my $item (@$Timetracker_list) {

      $hash{ $item->{name} }->{support} += $item->{num1};
      $hash{ $item->{name} }->{sprint}  += $item->{num2};
      $hash{ $item->{name} }->{osbb}    += $item->{num3};
    }

    my $coefficient;
    foreach my $item (sort keys %hash) {
      $coefficient = sprintf('%0.1f', (($hash{$item}->{support} * 100) / ($hash{$item}->{support} + $hash{$item}->{sprint} + $hash{$item}->{osbb})));
      $table->addrow($item, $hash{$item}->{support}, $hash{$item}->{sprint}, $hash{$item}->{osbb}, $coefficient);
    }

    print $table->show();

  }

}